"use strict";angular.module("baseApp.shared").directive("txSegmentViewer",function(){return{restrict:"E",scope:{segment:"="},template:"<div>{{segment}}</div>",replace:!0}}).directive("txEditorTabs",function(){return{restrict:"E",scope:{langs:"=",selectedLang:"=",limit:"@",onSelect:"&"},controller:["$scope",function(a){a.parseInt=parseInt,a.click=function(b){a.onSelect({index:b}),a.selectedLang=b}}],template:'<ul class="editor-tabs"><li ng-repeat="(idx, lang) in langs | limitTo: limit" ng-class="{selected: idx==selectedLang}" ng-click="click(idx)">{{lang}}</li><li class="more" ng-if="langs.length > limit">...<ul><li ng-repeat="(idx, lang) in langs | offset: limit" ng-click="click(idx)">{{lang}}</li></ul></li></ul>'}}).directive("txEditor",["$timeout","$compile","BingTranslator",function(a,b,c){return{restrict:"E",scope:{segment:"=",lockedTags:"=",langs:"=",selectedLang:"="},replace:!0,template:'<div class="tx-editor" ng-class="{\'locked-tags\':lockedTags}"><textarea></textarea></div>',link:function(d,e){var f=e.find("textarea")[0];d.translations=[],d.isValid=!0,d.lockedTags||(d.lockedTags=!1),d.selectedLang||(d.selectedLang=Object.keys(d.langs)[0]),d.changeLanguage=function(a){d.selectedLang=a},e.append(b('<tx-editor-tabs on-select="changeLanguage(index)" langs="langs" limit="2" selected-lang="selectedLang"></tx-editor-tabs>')(d)),e.prepend(b('<tx-segment-viewer segment="segment.source"></tx-segment-viewer>')(d)),e.append(b('<br/><p ng-hide="isValid">The segment is not valid!!!!</p>')(d));var g=[],h=[],i="",j="",k=function(){var b=0;return function(c,d){a.cancel(b),b=a(c,d)}}(),l=function(a){var b,c,d=a.indexOf(">"),e=a.indexOf('="');return-1===d&&-1===e?null:(-1===d?(b=e+2,c=a.substring(b,a.length).indexOf('"')):-1===e?(b=d+1,c=a.substring(b,a.length).indexOf("<")):e>d?(b=d+1,c=a.substring(b,a.length).indexOf("<")):(b=e+2,c=a.substring(b,a.length).indexOf('"')),-1===c&&(c=a.substring(b,a.length).length+1),c>-1?{from:b,to:b+c}:{from:b,to:b})},m=function(a){a=a.substr(0,a.length-1);var b,c,d=a.lastIndexOf(">"),e=a.lastIndexOf('="');return-1===d&&-1===e?{from:0,to:0}:(-1===d?(b=e+2,c=a.substring(b,a.length).indexOf('"')):-1===e?(b=d+1,c=a.substring(b,a.length).indexOf("<")):d>e?(b=d+1,c=a.substring(b,a.length).indexOf("<")):(b=e+2,c=a.substring(b,a.length).indexOf('"')),-1===c&&(c=a.substring(b,a.length).length+1),c>-1?{from:b,to:b+c}:{from:b,to:b})},n=function(a){var b=document.createElement("div");b.innerHTML=a;var c=b.textContent||b.innerText;return c.split(/[\s\,\.\!\¡\?\¿\:\;]+/)},o=CodeMirror.fromTextArea(f,{lineWrapping:!0,autoCloseBrackets:!0,extraKeys:{"Ctrl-Space":function(a){var b=a.getCursor(),e=a.getTokenAt(b),f=e.string.split(" "),g=f[f.length-1];if(g&&-1===g.indexOf("<")){var i=g,k=n(j),l=[];_.each(k,function(a){0===a.toLowerCase().indexOf(i.toLowerCase())&&l.push(a)}),c.getTranslations(l,d.selectedLang).then(function(b){h=b,a.showHint({completeSingle:!1})})}else a.showHint({completeSingle:!1})},"Alt-Down":function(a){return a.setValue(j),!1},"Alt-Right":function(a){var b="",c=a.getCursor();a.eachLine(c.line,a.lineCount(),function(d){b=d.text;var e=l(b.substr(c.ch));return e?(a.setSelection({line:c.line,ch:e.from+c.ch},{line:c.line,ch:e.to+c.ch}),!1):void 0})},"Alt-Left":function(a){var b="",c=a.getCursor("from");a.eachLine(c.line,a.lineCount(),function(d){b=d.text;var e=m(b.substring(0,c.ch));return e?(a.setSelection({line:c.line,ch:e.from},{line:c.line,ch:e.to}),!1):void 0})},Enter:function(){return!1}}});CodeMirror.registerHelper("hint","xml",function(a){var b=a.getCursor(),c=a.getTokenAt(b),d=c.string.split(" "),e=d[d.length-1],f=[];if(e&&-1===e.indexOf("<")){var i=e,j=c.string.lastIndexOf(i),k=0,l=c.string[c.string.length-1];return('"'===l||"'"===l)&&(k=1),_.each(h,function(a,b){0===b.toLowerCase().indexOf(i.toLowerCase())&&_.each(a,function(a){f.push({text:a,displayText:"("+b+") "+a})})}),{list:f,from:{line:b.line,ch:j+c.start},to:{line:b.line,ch:c.end-k}}}if("tag"===c.type)return _.each(g,function(a){0===a.tag.indexOf(c.string)&&f.push({text:a.text,displayText:"(TAG) "+a.tag})}),{list:f,from:{line:b.line,ch:c.start-1},to:{line:b.line,ch:c.end}};if("tag bracket"===c.type){if(-1!==c.string.indexOf(">"))return;return _.each(g,function(a){f.push({text:a.text,displayText:"(TAG) "+a.tag})}),{list:f,from:{line:b.line,ch:c.start},to:{line:b.line,ch:c.end}}}}),o.on("change",function(){d.segment.target[d.selectedLang]=o.getValue(),k(function(){d.$apply()},500)}),o.on("beforeChange",function(a,b){if(d.lockedTags){var c=a.getTokenAt(b.to),e=c?c.type:null,f=a.getTokenAt(b.from),g=f?f.type:null,h=b.origin,i=a.getSelection();if(!(i&&i.length>=1))return"+delete"===h&&(("tag"===e||"tag bracket"===e)&&b.cancel(),e||"tag"!==g||b.cancel()),"tag"===e&&"tag"===g?void b.cancel():void("tag bracket"!==e||"tag bracket"!==g||-1===c.string.indexOf("<")&&-1===c.string.indexOf("/")||b.cancel())}}),d.$watch("selectedLang",function(a){return a?(d.segment.target||(d.segment.target={}),i=d.segment.target[a],void o.setValue(i?i:"")):void o.setValue("")}),d.$watch("segment",function(a){return a?(g=[],j=a.source,a.target||(a.target={}),i=a.target[d.selectedLang],void o.setValue(i?i:"")):void o.setValue("")})}}}]);