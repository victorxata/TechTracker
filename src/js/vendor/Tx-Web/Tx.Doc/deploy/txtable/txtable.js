"use strict";angular.module("baseApp.shared").directive("txTable",["$sce","$parse",function(a,b){return{restrict:"E",scope:!0,priority:1,bindToController:!0,controllerAs:"txTableCtrl",compile:function(a,c){var d=angular.element('<div class="tx-headers"><div ng-repeat="col in txTableCtrl.columns" ng-hide="col.hide" ng-style="{\'max-width\':col.width, \'min-width\':col.width}"><input ng-if="txTableCtrl.selectedRows &amp;&amp; $first" ng-change="txTableCtrl.selectAllChange()" ng-model="txTableCtrl.selectAll" type="checkbox">{{col.emptyTitle?\'\':col.title}}</div></div>'),e=angular.element('<div class="tx-row filler" ng-click="txTableCtrl.internalRowClick($item)"></div>'),f=a.children(),g=angular.element('<div class="tx-table"></div>');return g.append(d),c.onFilter&&g.append(angular.element('<div class="tx-row-filters"><div ng-repeat="col in txTableCtrl.columns" ng-hide="col.hide" ng-style="{\'max-width\':col.width, \'min-width\':col.width}"><input ng-if="col.filterable &amp;&amp; !col.filterableValues" type="{{col.filterable}}" ng-model="txTableCtrl.filters[col.field]" ng-change="txTableCtrl.filter(col)"><select ng-if="col.filterable &amp;&amp; col.filterableValues" ng-options="item as item for item in col.filterableValues" ng-model="txTableCtrl.filters[col.field]" ng-change="txTableCtrl.filter(col)"><option value="">All</option></select></div></div>')),g.append(e.attr("ng-repeat","$item in "+c.data).append(f)),c.nextPage&&g.append(angular.element('<div class="tx-pages" ng-if="txTableCtrl.txPages"><ul><li ng-class="{\'active\':txTableCtrl.currentPage === page }" ng-repeat="page in txTableCtrl.pages"><a ng-click="txTableCtrl.goToPage(page)">{{page+1}}</a></li></ul></div>')),a.append(g),c.emptyMessage&&a.append(angular.element('<div ng-show="txTableCtrl.data.length === 0" class="tx-table-empty">{{txTableCtrl.emptyMessage}}</div>')),{pre:function(a,c,d,e){e.perPage=parseInt(d.perPage),e.dataProp=d.data,e.total=b(d.total)(a),e.nextPage=b(d.nextPage),e.onFilter=b(d.onFilter),e.currentPage=b(d.currentPage)(a),e.selectedRows=b(d.selectedRows)(a),e.emptyMessage=d.emptyMessage,e.rowClick=b(d.rowClick);var f=e;if(!_.isUndefined(f.perPage)&&!_.isUndefined(f.nextPage)&&!_.isUndefined(f.total)){f.txPages=!0;var g=f.total/f.perPage;f.pages=_.range(0,g),f.currentPage=f.currentPage?f.currentPage:0}},post:function(){}}},controller:["$scope","objectService",function(a,b){var c=this;c.columns=[],c.txPages={},c.filters={},c.showTotals=!1,c.addColumn=function(a){var b=_.findWhere(c.columns,{title:a.title});b||c.columns.push(a)},c.internalRowClick=function(b){c.rowClick(a,{$item:b})},c.updateSelection=function(a){if(a.selected)c.selectedRows.push(a);else{var b=c.selectedRows.indexOf(a);c.selectedRows.splice(b,1)}},c.selectAllChange=function(){c.selectedRows.length=0,b.getPropValue(a,c.dataProp).forEach(function(a){a.selected=c.selectAll,c.updateSelection(a)})},c.goToPage=function(b){c.currentPage=b,c.selectAll=!1;var d=c.nextPage(a,{$start:b*c.perPage,$length:c.perPage});d&&d.then&&d.then(function(a){if(!_.isArray(a))throw new Error("Response data for txTable must be in the form of an array");c.data.length=0,c.data=a})},c.columnIndex=function(a){return c.columns.indexOf(_.findWhere(c.columns,{title:a.title}))},c.filter=function(b){c.filters[b.field]||delete c.filters[b.field],c.onFilter(a,{$value:c.filters[b.field],$column:b.field,$filters:c.filters})}}]}}]).directive("txColumn",["$compile","$parse","objectService",function(a,b,c){return{restrict:"E",replace:!0,scope:!0,require:"^?txTable",transclude:!0,template:'<div ng-hide="hide" ng-style="{\'max-width\':width, \'min-width\':width}" ><input ng-if="itemIsSelectable" type="checkbox" ng-model="$item.selected" ng-change="txTableCtrl.updateSelection($item)" /><span ng-transclude></span></div>',link:function(a,d,e,f){a.width=e.width;var g={title:e.title,field:e.field,width:e.width,emptyTitle:e.emptyTitle,filterable:e.filterable,filterableValues:e.filterableValues};if(g.field){var h=g.field.indexOf("$item");h>-1&&(g.field=g.field.substr(h+"$item".length+1,g.field.length))}if(!g.title)throw new Error("a title attribute is required for tx-column");if((""===g.emptyTitle||g.emptyTitle)&&(g.emptyTitle=!0),g.filterable){var i=b(g.filterable)();i&&i instanceof Array&&(g.filterableValues=i)}_.isUndefined(e.hide)||(g.hide=c.getPropValue(a,e.hide),a.$watch(function(){return c.getPropValue(a,e.hide)},function(b){a.hide=b,g.hide=b})),f&&f.addColumn(g),a.itemIsSelectable=f&&f.selectedRows&&0===f.columnIndex(g)}}}]);